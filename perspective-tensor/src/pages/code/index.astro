---
import BaseLayout from '../../layouts/BaseLayout.astro';
import StructuredData from '../../components/StructuredData.astro';
import Tag from '../../components/Tag.astro';
import { getCollection } from 'astro:content';

// Get all code snippets/technical writeups
const codeSnippets = await getCollection('code', ({ data }) => data.draft !== true);

// Sort by date (newest first)
codeSnippets.sort((a, b) => {
  const dateA = a.data.pubDate || new Date(0);
  const dateB = b.data.pubDate || new Date(0);
  return dateB.getTime() - dateA.getTime();
});

// Structured data for the code section
const codeData = {
  "@type": "CollectionPage",
  name: "Technical Code Writeups",
  description: "Deep technical dives with working code snippets, implementation patterns, and system design insights.",
  url: new URL('/code', Astro.site || 'https://perspective-tensor.dev'),
  mainEntity: {
    "@type": "ItemList",
    itemListElement: codeSnippets.map((snippet, index) => ({
      "@type": "TechArticle",
      position: index + 1,
      name: snippet.data.title || snippet.id,
      description: snippet.data.description,
      url: new URL(`/code/${snippet.id}`, Astro.site || 'https://perspective-tensor.dev'),
      datePublished: snippet.data.pubDate?.toISOString()
    }))
  }
};
---

<BaseLayout 
  title="Code" 
  description="Technical writeups with working code snippets and implementation patterns"
>
  <StructuredData type="CollectionPage" data={codeData} />
  
  <div class="mx-auto px-4">
    <!-- Header -->
    <header class="mb-12">
      <div class="flex items-center gap-3 mb-4">
        <a 
          href="/"
          class="text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors font-light"
          data-astro-history="push"
        >
          Home
        </a>
        <span class="text-gray-400 dark:text-gray-600">/</span>
        <span class="text-sm text-gray-900 dark:text-gray-100 font-light">Code</span>
      </div>
      
      <h1 class="text-3xl font-light text-gray-900 dark:text-gray-100 mb-4">
        Technical Writeups
      </h1>
      <p class="text-base text-gray-600 dark:text-gray-400 font-light max-w-2xl">
        Deep dives into implementation details, system design patterns, and working code from production systems.
      </p>
    </header>
    
    <!-- Code Snippets Grid -->
    <div class="space-y-8">
      {codeSnippets.length === 0 ? (
        <div class="text-center py-16">
          <p class="text-gray-500 dark:text-gray-400 font-light mb-4">
            Technical writeups coming soon.
          </p>
          <p class="text-sm text-gray-400 dark:text-gray-500 font-light">
            Deep dives into Rust agents, memory systems, and performance patterns.
          </p>
        </div>
      ) : (
        codeSnippets.map((snippet) => (
          <article class="group">
            <a 
              href={`/code/${snippet.id}`}
              class="block p-6 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600 transition-all duration-300 hover:shadow-sm"
              data-astro-history="push"
            >
              <div class="flex items-start justify-between mb-3">
                <h2 class="text-xl font-light text-gray-900 dark:text-gray-100 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
                  {snippet.data.title || snippet.id}
                </h2>
                {snippet.data.pubDate && (
                  <time 
                    class="text-xs text-gray-500 dark:text-gray-400 font-light whitespace-nowrap ml-4" 
                    datetime={snippet.data.pubDate.toISOString()}
                  >
                    {snippet.data.pubDate.toLocaleDateString('en-US', { 
                      month: 'short',
                      day: 'numeric',
                      year: 'numeric'
                    })}
                  </time>
                )}
              </div>
              
              {snippet.data.description && (
                <p class="text-sm text-gray-600 dark:text-gray-400 font-light mb-3 leading-relaxed">
                  {snippet.data.description}
                </p>
              )}
              
              {snippet.data.tags && snippet.data.tags.length > 0 && (
                <div class="flex flex-wrap gap-2">
                  {snippet.data.tags.map((tag: string) => (
                    <Tag text={tag} />
                  ))}
                </div>
              )}
            </a>
          </article>
        ))
      )}
    </div>
  </div>
</BaseLayout>